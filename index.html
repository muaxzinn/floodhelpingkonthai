<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- Leaflet (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà OpenStreetMap) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    
  :root {
  --zoom-level: 1;   /* ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô = 100% */
}

#zoomRoot {
  transform: scale(var(--zoom-level));
  transform-origin: top left;
}

/* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏∞‡∏•‡∏∏‡∏à‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ scale */
body, html {
  overflow-x: hidden;
}
  
  :root {
      --primary: #2563eb;
      --primary-soft: #eff4ff;
      --danger: #ef4444;
      --success: #16a34a;
      --warning: #f59e0b;
      --bg: #f3f4f6;
      --text: #111827;
      --card: #ffffff;
      --border: #e5e7eb;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #dbeafe 0, #f3f4f6 50%, #e5e7eb 100%);
      color: var(--text);
      min-height: 100vh;
      margin: 0;
      display: flex;
    }

    /* ‡πÉ‡∏´‡πâ container ‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
    .app-container {
      width: 100%;
      max-width: 100%;
      min-height: 100vh;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 0;
      box-shadow: none;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      backdrop-filter: blur(10px);
      border: none;
    }

    @media (min-width: 768px) {
      .app-container {
        padding: 16px 24px;
      }
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #60a5fa, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 20px;
      box-shadow: 0 0 20px rgba(37, 99, 235, 0.5);
    }

    .app-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .app-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      font-size: 11px;
      font-weight: 500;
      align-self: flex-start;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }

    .tab-bar {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      padding: 4px;
      background: #e5e7eb;
      border-radius: 999px;
      position: relative;
      margin-top: 4px;
    }

    .tab-btn {
      position: relative;
      z-index: 1;
      border: none;
      background: transparent;
      padding: 8px 0;
      font-size: 14px;
      border-radius: 999px;
      cursor: pointer;
      color: #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: color 0.18s ease;
    }

    .tab-btn span.icon {
      font-size: 16px;
    }

    .tab-btn.active {
      color: #111827;
      font-weight: 600;
    }

    .tab-indicator {
      position: absolute;
      top: 4px;
      bottom: 4px;
      width: calc(50% - 4px);
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
      transition: transform 0.2s ease;
    }

    .tab-indicator.right {
      transform: translateX(100%);
    }

    /* main ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô layout ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á grid ‡∏™‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á) */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-top: 8px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 16px rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
      /* ‡πÉ‡∏´‡πâ card ‡∏™‡∏π‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á scroll ‡πÑ‡∏î‡πâ */
      max-height: calc(100vh - 130px);
      overflow: auto;
    }

    @media (min-width: 900px) {
      .card {
        padding: 16px 18px;
        max-height: calc(100vh - 140px);
      }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-emoji {
      font-size: 18px;
    }

    .card-desc {
      font-size: 12px;
      color: #6b7280;
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, #e5e7eb, transparent);
    }

    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-label {
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .field-label span.required {
      font-size: 11px;
      color: var(--danger);
    }

    .field-hint {
      font-size: 11px;
      color: #9ca3af;
    }

    input[type="text"],
    input[type="tel"],
    textarea {
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
    }

    input[type="text"]:focus,
    input[type="tel"]:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
      background: #ffffff;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.16s ease;
      white-space: nowrap;
    }

    .btn:active {
      transform: scale(0.97);
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      box-shadow: 0 10px 18px rgba(37, 99, 235, 0.35);
    }

    .btn-outline {
      background: #f9fafb;
      color: #1f2937;
      border: 1px solid #d1d5db;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .btn-icon {
      font-size: 14px;
    }

    .location-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .location-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #6b7280;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .location-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .location-status-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
    }

    .image-input {
      border-radius: 12px;
      border: 1px dashed #cbd5f5;
      padding: 10px;
      background: #eff6ff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .image-input-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #1d4ed8;
    }

    .image-preview-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .image-chip {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #bfdbfe;
      background: #e5e7eb;
    }

    .image-chip img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .image-chip span {
      position: absolute;
      bottom: 2px;
      right: 4px;
      background: rgba(15, 23, 42, 0.7);
      color: white;
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 999px;
    }

    .helper-info {
      font-size: 12px;
      color: #4b5563;
      background: #f3f4ff;
      border-radius: 12px;
      padding: 8px;
      border: 1px solid #e5e7eb;
    }

    .status-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .status-waiting {
      background: #fef3c7;
      color: #92400e;
    }

    .status-waiting .status-dot {
      background: #f59e0b;
    }

    .status-accepted {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .status-accepted .status-dot {
      background: #2563eb;
    }

    .status-completed {
      background: #dcfce7;
      color: #166534;
    }

    .status-completed .status-dot {
      background: #22c55e;
    }

    .status-cancelled {
      background: #fee2e2;
      color: #b91c1c;
    }

    .status-cancelled .status-dot {
      background: #ef4444;
    }

    .table-wrapper {
      position: relative;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 8px;
      max-height: 100%;
      overflow: auto;
      scroll-behavior: smooth;
    }

    .group-header {
      position: sticky;
      top: 0;
      background: #f9fafb;
      padding: 5px 6px;
      font-size: 11px;
      font-weight: 600;
      color: #4b5563;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 2;
    }

    .group-header span.location-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .group-header span.badge {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      background: #e5e7eb;
      color: #374151;
    }

    .case-row {
      background: white;
      border-radius: 10px;
      padding: 8px 8px;
      margin-top: 6px;
      border: 1px solid #e5e7eb;
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.2fr);
      gap: 8px;
      cursor: pointer;
      transition: background 0.12s ease, box-shadow 0.12s ease, transform 0.06s ease;
    }

    .case-row:active {
      transform: scale(0.99);
      box-shadow: none;
    }

    .case-row:hover {
      box-shadow: 0 8px 16px rgba(148, 163, 184, 0.25);
    }

    .case-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .case-topline {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .case-name {
      font-size: 13px;
      font-weight: 600;
    }

    .case-time {
      font-size: 11px;
      color: #9ca3af;
    }

    .case-needs {
      font-size: 12px;
      color: #374151;
    }

    .case-situation {
      font-size: 11px;
      color: #6b7280;
      max-height: 32px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .case-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: #4b5563;
      align-items: flex-end;
      justify-content: space-between;
    }

    .case-distance {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    .case-actions {
      display: flex;
      gap: 4px;
    }

    .badge-soft {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 11px;
      background: #f3f4f6;
      color: #4b5563;
    }

    .map-container {
      width: 100%;
      height: 220px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    .muted {
      color: #9ca3af;
    }

    .small {
      font-size: 11px;
    }

    .toast {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: #f9fafb;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 50;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -4px);
    }

    .badge-gps {
      padding: 3px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-gps-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .badge-gps.off .badge-gps-dot {
      background: #9ca3af;
      box-shadow: none;
    }

    .badge-gps.off {
      background: #f3f4f6;
      color: #6b7280;
    }

    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    .loading-spinner {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.5);
      border-top-color: #2563eb;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .tag {
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4f46e5;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 11px;
      color: #4b5563;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 12px;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-card {
      background: white;
      border-radius: 20px;
      max-width: 460px;
      width: 100%;
      padding: 14px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.45);
      max-height: 90vh;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .modal-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .modal-close {
      border-radius: 999px;
      width: 28px;
      height: 28px;
      border: none;
      background: #f3f4f6;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #6b7280;
    }

    .modal-section {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      background: #f9fafb;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .modal-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
    }

    .modal-grid-two {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .gallery-row {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .gallery-thumb {
      flex: 0 0 auto;
      width: 90px;
      height: 70px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      background: #111827;
    }

    .gallery-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .badge-small {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .text-muted {
      color: #9ca3af;
    }

    .text-danger {
      color: #b91c1c;
    }
  </style>
</head>
<body>
<div class="app-container">
  <header>
    <div class="logo-row">
      <div class="logo-badge">F</div>
      <div>
        <div class="app-title">Flood Help Center</div>
        <div class="app-subtitle">
          ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        </div>
        
        
      </div>
    </div>
    <div class="pill">
      <span class="pill-dot"></span>
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡∏ö‡∏ô Cloud (Firestore + Storage) ‡∏ü‡∏£‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
    </div>
    <div class="tab-bar">
      <div class="tab-indicator" id="tabIndicator"></div>
      <button class="tab-btn active" id="tabFormBtn">
        <span class="icon">üÜò</span> ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
      </button>
      <button class="tab-btn" id="tabListBtn">
        <span class="icon">üìç</span> ‡∏î‡∏π‡πÄ‡∏Ñ‡∏™‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì
      </button>
    </div>
  </header>

  <main>
    <!-- ‡∏´‡∏ô‡πâ‡∏≤ 1: ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠) -->
    <section class="card" id="formSection">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="card-title-emoji">üÜò</span> ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
          </div>
          <p class="card-desc">
            ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö + ‡πÄ‡∏õ‡∏¥‡∏î GPS + ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏£‡∏¥‡∏á (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
          </p>
        </div>
      </div>
      <div class="divider"></div>

      <form class="form-grid" id="helpForm">
        <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</div>

        <div class="field">
          <label class="field-label">
            ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
            <span class="required">* ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>
          </label>
          <input type="text" id="requesterName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" required>
        </div>

        <div class="field">
          <label class="field-label">
            ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å
            <span class="required">* ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>
          </label>
          <input type="tel" id="requesterPhone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 08xxxxxxxx" required>
          <div class="field-hint">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</div>
        </div>

        <div class="field">
          <label class="field-label">
            ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          </label>
          <input type="text" id="requesterContactAlt" placeholder="LINE ID / Facebook / ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">
        </div>

        <div class="divider"></div>
        <div class="section-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>

        <div class="field">
          <label class="field-label">
            ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            <span class="required">* ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>
          </label>
          <input type="text" id="needs" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á, ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà" required>
        </div>

        <div class="field">
          <label class="field-label">
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
            <span class="required">* ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>
          </label>
          <textarea id="situation" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≥‡∏™‡∏π‡∏á‡∏ñ‡∏∂‡∏á‡∏≠‡∏Å ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ 1 ‡∏Ñ‡∏ô ‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å 2 ‡∏Ñ‡∏ô ‡πÑ‡∏ü‡∏î‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß"></textarea>
        </div>

        <div class="divider"></div>
        <div class="section-title">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>

        <div class="field">
          <label class="field-label">
            ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å GPS
          </label>
          <div class="location-row">
            <button type="button" class="btn btn-outline btn-sm" id="btnUseCurrentLocation">
              <span class="btn-icon">üìç</span> ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
            </button>
            <div class="location-status" id="locationStatus">
              <span class="location-status-dot" id="locationStatusDot"></span>
              <span id="locationStatusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
            </div>
          </div>
          <div class="field-hint">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ GPS + ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </div>
        </div>

        <div class="field">
          <label class="field-label">
            ‡∏ï‡∏≥‡∏ö‡∏• / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
          </label>
          <div class="chips-row" id="areaChips">
            <span class="chip muted small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
          </div>
          <div class="field-hint">
            ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </div>
        </div>

        <div id="mapWrapper" class="field" style="display:none;">
          <label class="field-label">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ)</label>
          <div id="map" class="map-container"></div>
          <div class="field-hint">
            ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏¢‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ
          </div>
        </div>

        <div class="divider"></div>
        <div class="section-title">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ)</div>

        <div class="field">
          <div class="image-input">
            <div class="image-input-header">
              <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏£‡∏¥‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)</span>
              <label class="btn btn-outline btn-sm" style="cursor:pointer;">
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‚Ä¶
                <input type="file" id="victimImages" accept="image/*" multiple style="display:none;">
              </label>
            </div>
            <div class="field-hint">
              ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ñ‡πà‡∏≤‡∏¢: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥, ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô, ‡∏õ‡πâ‡∏≤‡∏¢‡∏ã‡∏≠‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
            </div>
            <div class="image-preview-grid" id="victimImagePreview"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="helper-info">
          <strong>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud</strong><br>
          ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Firestore collection <code>help_requests</code><br>
          - ‡∏™‡∏£‡πâ‡∏≤‡∏á document ‡πÉ‡∏´‡∏°‡πà 1 ‡∏ï‡∏±‡∏ß / 1 ‡πÄ‡∏Ñ‡∏™<br>
          - ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å: ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå, ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™, ‡πÄ‡∏ß‡∏•‡∏≤<br>
          - ‡∏£‡∏π‡∏õ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Firebase Storage ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå <code>victim_images/{helpRequestId}/...</code><br>
          - Firestore ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
        </div>

        <button type="submit" class="btn btn-primary btn-full" id="submitHelpBtn">
          <span class="btn-icon">üì§</span> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        </button>
      </form>
    </section>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤ 2: Dashboard ‡∏î‡∏π‡πÄ‡∏Ñ‡∏™ (‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠) -->
    <section class="card" id="listSection" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="card-title-emoji">üìç</span> ‡πÄ‡∏Ñ‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì
          </div>
          <p class="card-desc">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏Ñ‡∏™‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
          </p>
        </div>
        <div class="badge-gps off" id="gpsBadge">
          <span class="badge-gps-dot"></span> GPS ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        </div>
      </div>
      <div class="divider"></div>

      <div class="info-row">
        <div class="tag" id="viewerAreaTag">
          <span class="tag-dot"></span>
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏∏‡∏ì
        </div>
        <button class="btn btn-outline btn-sm" id="btnRefreshCases">
          <span class="btn-icon">üîÑ</span> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏Ñ‡∏™ / ‡∏î‡∏∂‡∏á GPS ‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>

      <div class="table-wrapper" id="casesContainer">
        <div style="padding:8px; font-size:12px; color:#6b7280;">
          ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏™‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ~1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠<br>
          ‡πÄ‡∏Ñ‡∏™‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏ä‡πà‡∏ß‡∏¢ / ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß / ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™
        </div>
      </div>

      <div class="helper-info">
        <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</strong><br>
        ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô document ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà Firestore:<br>
        - ‡∏ü‡∏¥‡∏•‡∏î‡πå <code>helperName</code>, <code>helperPhone</code>, <code>helperContactAlt</code><br>
        - ‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Storage: <code>helper_images/{helpRequestId}/...</code><br>
        - ‡∏ü‡∏¥‡∏•‡∏î‡πå <code>helperImageUrl</code> ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö URL ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Firestore<br>
        - ‡∏ü‡∏¥‡∏•‡∏î‡πå <code>status</code> ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô <code>"accepted"</code> ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô <code>helperAcceptedAt</code>
      </div>
    </section>
  </main>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Modal ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™ -->
<div class="modal-backdrop" id="acceptModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <span>ü§ù</span> ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
      </div>
      <button class="modal-close" data-close-modal="acceptModal">‚úï</button>
    </div>
    <div class="card-desc" style="font-size:12px;">
      ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏ì/‡∏ó‡∏µ‡∏°/‡∏£‡∏ñ/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå)
    </div>

    <div class="modal-section" id="acceptCaseInfo">
      <div class="modal-section-title">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢</div>
      <div id="acceptCaseSummary" class="small"></div>
    </div>

    <form id="acceptForm" class="form-grid" style="margin-top:4px;">
      <div class="field">
        <label class="field-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span class="required">* ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span></label>
        <input type="text" id="helperName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏°‡∏±‡∏á ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡∏° A" required>
      </div>
      <div class="field">
        <label class="field-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ <span class="required">* ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span></label>
        <input type="tel" id="helperPhone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 08xxxxxxxx" required>
      </div>
      <div class="field">
        <label class="field-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
        <input type="text" id="helperContactAlt" placeholder="LINE ID / Facebook / ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">
      </div>
      <div class="field">
        <label class="field-label">‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ)</label>
        <div class="image-input">
          <div class="image-input-header">
            <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ / ‡∏ó‡∏µ‡∏° / ‡∏£‡∏ñ ‡∏Ø‡∏•‡∏Ø</span>
            <label class="btn btn-outline btn-sm" style="cursor:pointer;">
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‚Ä¶
              <input type="file" id="helperImageInput" accept="image/*" style="display:none;">
            </label>
          </div>
          <div class="image-preview-grid" id="helperImagePreview"></div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:4px;">
        <button type="submit" class="btn btn-primary btn-full" id="acceptSubmitBtn">
          <span class="btn-icon">‚úÖ</span> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™ -->
<div class="modal-backdrop" id="detailModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <span>üìÑ</span> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </div>
      <button class="modal-close" data-close-modal="detailModal">‚úï</button>
    </div>

    <div id="detailContent" class="small">
      <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
    </div>
  </div>
</div>

<script>
  // =========================
  // 1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase
  // =========================
  // TODO: ‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤ config ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á (‡∏à‡∏≤‡∏Å Firebase console)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ‡∏ä‡∏∑‡πà‡∏≠ collection ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ñ‡∏™
  const HELP_COLLECTION = "help_requests";

  // =========================
  // 2) ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
  // =========================
  let currentLat = null;
  let currentLng = null;
  let currentArea = {
    provinceCode: null,
    provinceName: null,
    districtCode: null,
    districtName: null,
    subdistrictCode: null,
    subdistrictName: null
  };

  let map;
  let mapMarker;

  let viewerLat = null;
  let viewerLng = null;
  let viewerArea = {
    provinceName: null,
    districtName: null,
    subdistrictName: null
  };

  let allCases = []; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
  let unsubscribeCases = null; // ‡πÑ‡∏ß‡πâ stop realtime listener ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

  let longPressTimer = null;
  let longPressTargetId = null;
  let longPressData = null;

  let selectedCaseForAccept = null; // document data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö modal ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™
  let selectedCaseIdForAccept = null;

  let helperImageFile = null; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢

  // =========================
  // 3) DOM helpers
  // =========================
  const $ = (id) => document.getElementById(id);

  function showToast(message, type = "default") {
    const toast = $("toast");
    toast.textContent = message;
    toast.classList.add("show");
    if (type === "error") {
      toast.style.background = "#b91c1c";
    } else if (type === "success") {
      toast.style.background = "#16a34a";
    } else {
      toast.style.background = "#111827";
    }
    setTimeout(() => {
      toast.classList.remove("show");
    }, 2600);
  }

  function formatDateTime(ts) {
    if (!ts) return "-";
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    const dd = d.getDate().toString().padStart(2, "0");
    const mm = (d.getMonth() + 1).toString().padStart(2, "0");
    const yy = d.getFullYear();
    const hh = d.getHours().toString().padStart(2, "0");
    const min = d.getMinutes().toString().padStart(2, "0");
    return `${dd}/${mm}/${yy} ${hh}:${min} ‡∏ô.`;
  }

  function statusBadge(status) {
    const s = (status || "").toLowerCase();
    if (s === "waiting") {
      return '<span class="status-badge status-waiting"><span class="status-dot"></span>‡∏£‡∏≠‡∏Ñ‡∏ô‡∏ä‡πà‡∏ß‡∏¢</span>';
    } else if (s === "accepted") {
      return '<span class="status-badge status-accepted"><span class="status-dot"></span>‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß</span>';
    } else if (s === "completed") {
      return '<span class="status-badge status-completed"><span class="status-dot"></span>‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';
    } else if (s === "cancelled") {
      return '<span class="status-badge status-cancelled"><span class="status-dot"></span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
    }
    return '<span class="status-badge status-waiting"><span class="status-dot"></span>‡∏£‡∏≠‡∏Ñ‡∏ô‡∏ä‡πà‡∏ß‡∏¢</span>';
  }

  // =========================
  // 4) TAB ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
  // =========================
  const tabIndicator = $("tabIndicator");
  const tabFormBtn = $("tabFormBtn");
  const tabListBtn = $("tabListBtn");
  const formSection = $("formSection");
  const listSection = $("listSection");

  tabFormBtn.addEventListener("click", () => {
    tabFormBtn.classList.add("active");
    tabListBtn.classList.remove("active");
    tabIndicator.classList.remove("right");
    formSection.style.display = "flex";
    listSection.style.display = "none";
  });

  tabListBtn.addEventListener("click", () => {
    tabListBtn.classList.add("active");
    tabFormBtn.classList.remove("active");
    tabIndicator.classList.add("right");
    formSection.style.display = "none";
    listSection.style.display = "flex";
    // ‡∏ï‡∏≠‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ list ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á GPS + ‡πÄ‡∏Ñ‡∏™
    initViewerLocationAndCases();
  });

  // =========================
  // 5) ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ + ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  // =========================
  const btnUseCurrentLocation = $("btnUseCurrentLocation");
  const locationStatus = $("locationStatus");
  const locationStatusDot = $("locationStatusDot");
  const locationStatusText = $("locationStatusText");
  const areaChips = $("areaChips");
  const mapWrapper = $("mapWrapper");

  btnUseCurrentLocation.addEventListener("click", () => {
    if (!navigator.geolocation) {
      showToast("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á", "error");
      return;
    }
    locationStatusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‚Ä¶";
    locationStatusDot.classList.remove("ok");

    navigator.geolocation.getCurrentPosition(async (pos) => {
      currentLat = pos.coords.latitude;
      currentLng = pos.coords.longitude;

      locationStatusDot.classList.add("ok");
      locationStatusText.textContent = "‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";

      showToast("‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");

      // ‡πÉ‡∏ä‡πâ reverse geocoding ‡πÄ‡∏≠‡∏≤ lat/lng -> ‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
      try {
        const area = await reverseGeocode(currentLat, currentLng);
        currentArea = area;
        renderAreaChips(areaChips, area);
      } catch (e) {
        console.error(e);
        showToast("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ lat/lng ‡πÑ‡∏î‡πâ", "error");
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà + marker
      mapWrapper.style.display = "block";
      initOrUpdateMap(currentLat, currentLng, true);

    }, (err) => {
      console.error(err);
      locationStatusDot.classList.remove("ok");
      locationStatusText.textContent = "‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS", "error");
    }, {
      enableHighAccuracy: true,
      timeout: 15000
    });
  });

  function renderAreaChips(container, area) {
    container.innerHTML = "";
    if (!area.provinceName && !area.districtName && !area.subdistrictName) {
      container.innerHTML = '<span class="chip muted small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>';
      return;
    }
    if (area.subdistrictName) {
      container.innerHTML += `<span class="chip">‡∏ï.${area.subdistrictName}</span>`;
    }
    if (area.districtName) {
      container.innerHTML += `<span class="chip">‡∏≠.${area.districtName}</span>`;
    }
    if (area.provinceName) {
      container.innerHTML += `<span class="chip">‡∏à.${area.provinceName}</span>`;
    }
  }

  function initOrUpdateMap(lat, lng, focus = false) {
    if (!map) {
      map = L.map("map").setView([lat, lng], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(map);

      mapMarker = L.marker([lat, lng], {draggable: true}).addTo(map);

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡πâ update currentLat/Lng
      mapMarker.on("moveend", (e) => {
        const p = e.target.getLatLng();
        currentLat = p.lat;
        currentLng = p.lng;
      });

    } else {
      map.setView([lat, lng], focus ? 15 : map.getZoom());
      mapMarker.setLatLng([lat, lng]);
    }
  }

  // =========================
  // 6) Reverse Geocoding (‡πÉ‡∏ä‡πâ OpenStreetMap Nominatim)
  // =========================
  async function reverseGeocode(lat, lng) {
    // Nominatim ‡∏ü‡∏£‡∏µ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û (‡πÑ‡∏°‡πà spam)
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
    const res = await fetch(url, {
      headers: {
        "Accept-Language": "th,en"
      }
    });
    if (!res.ok) throw new Error("Reverse geocoding failed");
    const data = await res.json();
    const addr = data.address || {};

    // ‡∏Ñ‡πà‡∏≤‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö address ‡∏Ç‡∏≠‡∏á OSM
    const provinceName = addr.state || addr.region || null;
    const districtName = addr.county || addr.city_district || addr.district || null;
    const subdistrictName = addr.village || addr.suburb || addr.town || null;

    // ‡πÑ‡∏°‡πà‡∏°‡∏µ code ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å OSM ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ -> ‡πÉ‡∏™‡πà null ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    return {
      provinceCode: null,
      provinceName,
      districtCode: null,
      districtName,
      subdistrictCode: null,
      subdistrictName
    };
  }

  // =========================
  // 7) ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢
  // =========================
  const victimImagesInput = $("victimImages");
  const victimImagePreview = $("victimImagePreview");

  victimImagesInput.addEventListener("change", () => {
    const files = Array.from(victimImagesInput.files || []);
    if (files.length > 3) {
      showToast("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ 3 ‡∏£‡∏π‡∏õ‡πÅ‡∏£‡∏Å", "error");
    }
    const showFiles = files.slice(0, 3);
    victimImagePreview.innerHTML = "";
    showFiles.forEach((file, idx) => {
      const url = URL.createObjectURL(file);
      const div = document.createElement("div");
      div.className = "image-chip";
      div.innerHTML = `<img src="${url}"><span>${idx + 1}</span>`;
      victimImagePreview.appendChild(div);
    });
  });

  // =========================
  // 8) ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  // =========================
  const helpForm = $("helpForm");
  const submitHelpBtn = $("submitHelpBtn");

  helpForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = $("requesterName").value.trim();
    const phone = $("requesterPhone").value.trim();
    const contactAlt = $("requesterContactAlt").value.trim();
    const needs = $("needs").value.trim();
    const situation = $("situation").value.trim();

    if (!name || !phone || !needs) {
      showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ * ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "error");
      return;
    }

    const files = Array.from(victimImagesInput.files || []);
    if (files.length === 0) {
      showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ", "error");
      return;
    }

    if (!currentLat || !currentLng) {
      showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠", "error");
      return;
    }

    submitHelpBtn.disabled = true;
    submitHelpBtn.innerHTML = '<span class="loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶';

    try {
      // 1) ‡∏™‡∏£‡πâ‡∏≤‡∏á document reference ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ id ‡∏Å‡πà‡∏≠‡∏ô
      const docRef = db.collection(HELP_COLLECTION).doc();
      const docId = docRef.id;

      // 2) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Storage
      const uploadFiles = files.slice(0, 3); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î 3 ‡∏£‡∏π‡∏õ
      const uploadedUrls = [];

      for (let i = 0; i < uploadFiles.length; i++) {
        const file = uploadFiles[i];
        const ext = file.name.split(".").pop();
        const fileName = `victim_${Date.now()}_${i}.${ext}`;
        const storageRef = storage.ref().child(`victim_images/${docId}/${fileName}`);
        await storageRef.put(file);
        const url = await storageRef.getDownloadURL();
        uploadedUrls.push(url);
      }

      // 3) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Firestore (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á document)
      const docData = {
        // ‡πÄ‡∏ß‡∏•‡∏≤
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),

        // ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢
        requesterName: name,
        requesterPhone: phone,
        requesterContactAlt: contactAlt || null,
        needs: needs,
        situation: situation || null,

        // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á / ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
        locationLat: currentLat,
        locationLng: currentLng,
        provinceCode: currentArea.provinceCode,
        provinceName: currentArea.provinceName,
        districtCode: currentArea.districtCode,
        districtName: currentArea.districtName,
        subdistrictCode: currentArea.subdistrictCode,
        subdistrictName: currentArea.subdistrictName,
        addressNote: null,

        // ‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢
        victimImageUrls: uploadedUrls,

        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™
        status: "waiting", // waiting | accepted | completed | cancelled

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô null)
        helperName: null,
        helperPhone: null,
        helperContactAlt: null,
        helperImageUrl: null,
        helperAcceptedAt: null,
        completedAt: null
      };

      // 4) ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á Firestore
      await docRef.set(docData);

      showToast("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");

      // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ
      helpForm.reset();
      victimImagePreview.innerHTML = "";
      currentLat = null;
      currentLng = null;
      currentArea = {
        provinceCode: null,
        provinceName: null,
        districtCode: null,
        districtName: null,
        subdistrictCode: null,
        subdistrictName: null
      };
      areaChips.innerHTML = '<span class="chip muted small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>';
      locationStatusText.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
      locationStatusDot.classList.remove("ok");
      mapWrapper.style.display = "none";

    } catch (err) {
      console.error(err);
      showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
    } finally {
      submitHelpBtn.disabled = false;
      submitHelpBtn.innerHTML = '<span class="btn-icon">üì§</span> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
    }
  });

  // =========================
  // 9) ‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡πÄ‡∏Ñ‡∏™: ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á viewer + ‡πÄ‡∏Ñ‡∏™
  // =========================
  const gpsBadge = $("gpsBadge");
  const viewerAreaTag = $("viewerAreaTag");
  const casesContainer = $("casesContainer");
  const btnRefreshCases = $("btnRefreshCases");

  btnRefreshCases.addEventListener("click", () => {
    initViewerLocationAndCases(true);
  });

  async function initViewerLocationAndCases(force = false) {
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ listener ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ unsubscribe ‡∏Å‡πà‡∏≠‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô)
    if (force && unsubscribeCases) {
      unsubscribeCases();
      unsubscribeCases = null;
    }

    if (!navigator.geolocation) {
      showToast("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS", "error");
      return;
    }

    gpsBadge.classList.add("off");
    gpsBadge.querySelector(".badge-gps-dot").classList.remove("ok");
    gpsBadge.innerHTML = '<span class="badge-gps-dot"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á GPS‚Ä¶';

    navigator.geolocation.getCurrentPosition(async (pos) => {
      viewerLat = pos.coords.latitude;
      viewerLng = pos.coords.longitude;

      gpsBadge.classList.remove("off");
      gpsBadge.querySelector(".badge-gps-dot").classList.add("ok");
      gpsBadge.innerHTML = '<span class="badge-gps-dot"></span> GPS ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';

      try {
        const area = await reverseGeocode(viewerLat, viewerLng);
        viewerArea = {
          provinceName: area.provinceName,
          districtName: area.districtName,
          subdistrictName: area.subdistrictName
        };
        renderAreaChips(viewerAreaTag, area); // reuse function ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡πá‡∏Å‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô
      } catch (e) {
        console.error(e);
        viewerAreaTag.innerHTML = '<span class="tag-dot"></span> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ';
      }

      // ‡∏ï‡∏±‡πâ‡∏á listener ‡πÅ‡∏ö‡∏ö realtime ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏™
      setupCasesListener();

    }, (err) => {
      console.error(err);
      gpsBadge.classList.add("off");
      gpsBadge.innerHTML = '<span class="badge-gps-dot"></span> GPS ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß / ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï';
      showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ", "error");
    }, {
      enableHighAccuracy: true,
      timeout: 15000
    });
  }

  function setupCasesListener() {
    // ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    if (unsubscribeCases) return;

    casesContainer.innerHTML = '<div style="padding:8px;font-size:12px;color:#6b7280;display:flex;align-items:center;gap:8px;"><span class="loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏™‡∏à‡∏≤‡∏Å Cloud‚Ä¶</div>';

    unsubscribeCases = db.collection(HELP_COLLECTION)
      .orderBy("createdAt", "desc")
      .limit(200) // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
      .onSnapshot((snap) => {
        allCases = [];
        snap.forEach(doc => {
          const data = doc.data();
          allCases.push({
            id: doc.id,
            ...data
          });
        });
        renderCases();
      }, (err) => {
        console.error(err);
        showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏™‡πÑ‡∏î‡πâ", "error");
      });
  }

  // =========================
  // 10) ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏™ + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
  // =========================
  function distanceKm(lat1, lon1, lat2, lon2) {
    if (!lat1 || !lon1 || !lat2 || !lon2) return null;
    const R = 6371; // km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) *
      Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function renderCases() {
    if (!allCases.length) {
      casesContainer.innerHTML = '<div style="padding:8px;font-size:12px;color:#6b7280;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>';
      return;
    }

    const group1 = [];
    const group2 = [];
    const group3 = [];
    const group4 = [];

    allCases.forEach((c) => {
      if (!c.status || ["waiting", "accepted"].indexOf(c.status.toLowerCase()) === -1) {
        return; // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ waiting + accepted
      }

      const dist = distanceKm(viewerLat, viewerLng, c.locationLat, c.locationLng);
      const withDist = {...c, distanceKm: dist};

      const sName = (c.subdistrictName || "").trim();
      const dName = (c.districtName || "").trim();
      const pName = (c.provinceName || "").trim();
      const vs = (viewerArea.subdistrictName || "").trim();
      const vd = (viewerArea.districtName || "").trim();
      const vp = (viewerArea.provinceName || "").trim();

      if (sName && vs && sName === vs) {
        group1.push(withDist);
      } else if (dName && vd && dName === vd) {
        group2.push(withDist);
      } else if (pName && vp && pName === vp) {
        group3.push(withDist);
      } else {
        group4.push(withDist);
      }
    });

    const sortByDistance = (arr) => {
      arr.sort((a, b) => {
        const da = a.distanceKm ?? 999999;
        const db = b.distanceKm ?? 999999;
        return da - db;
      });
    };

    sortByDistance(group1);
    sortByDistance(group2);
    sortByDistance(group3);
    sortByDistance(group4);

    let html = "";

    function renderGroup(title, subtitle, arr) {
      if (!arr.length) return;
      html += `<div class="group-header">
        <span class="location-label">${title}<span class="badge">${subtitle}</span></span>
        <span class="small muted">‡πÄ‡∏Ñ‡∏™: ${arr.length}</span>
      </div>`;
      arr.forEach(caseData => {
        html += renderCaseRow(caseData);
      });
    }

    const subText = viewerArea.subdistrictName ? `‡∏ï‡∏≥‡∏ö‡∏• ${viewerArea.subdistrictName}` : "‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô";
    const disText = viewerArea.districtName ? `‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ${viewerArea.districtName}` : "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô";
    const provText = viewerArea.provinceName ? `‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ${viewerArea.provinceName}` : "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô";

    renderGroup("‡πÄ‡∏Ñ‡∏™‡πÉ‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì", subText, group1);
    renderGroup("‡πÄ‡∏Ñ‡∏™‡πÉ‡∏ô‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì", disText, group2);
    renderGroup("‡πÄ‡∏Ñ‡∏™‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì", provText, group3);
    renderGroup("‡πÄ‡∏Ñ‡∏™‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", "‡∏ô‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì", group4);

    casesContainer.innerHTML = html;

    attachCaseRowEvents();
  }

  function renderCaseRow(c) {
    const distanceLabel = c.distanceKm != null
      ? `${c.distanceKm.toFixed(1)} ‡∏Å‡∏°.`
      : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á";

    const areaText =
      (c.subdistrictName ? `‡∏ï.${c.subdistrictName} ` : "") +
      (c.districtName ? `‡∏≠.${c.districtName} ` : "") +
      (c.provinceName ? `‡∏à.${c.provinceName}` : "");

    const situationShort = (c.situation || "").length > 80
      ? (c.situation || "").slice(0, 80) + "‚Ä¶"
      : (c.situation || "");

    return `
      <div class="case-row"
           data-case-id="${c.id}"
           data-longpress="false">
        <div class="case-main">
          <div class="case-topline">
            <div class="case-name">${c.requesterName || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"}</div>
            <div class="case-time">${formatDateTime(c.createdAt)}</div>
          </div>
          <div class="case-needs">
            ${c.needs || "-"}
          </div>
          <div class="case-situation">
            ${situationShort || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå"}
          </div>
        </div>
        <div class="case-meta">
          <div class="case-distance">${distanceLabel}</div>
          <div class="case-actions">
            ${statusBadge(c.status)}
          </div>
          <div class="badge-soft">${areaText || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"}</div>
          <button class="btn btn-outline btn-sm" data-detail-id="${c.id}">
            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
          </button>
        </div>
      </div>
    `;
  }

  // =========================
  // 11) Event ‡πÄ‡∏Ñ‡∏™ (Long press + Detail)
  // =========================
  function attachCaseRowEvents() {
    const rows = casesContainer.querySelectorAll(".case-row");
    rows.forEach(row => {
      const caseId = row.getAttribute("data-case-id");

      // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥ -> ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      const detailBtn = row.querySelector("[data-detail-id]");
      if (detailBtn) {
        detailBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = detailBtn.getAttribute("data-detail-id");
          const cdata = allCases.find(x => x.id === id);
          if (cdata) openDetailModal(cdata);
        });
      }

      // long press ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
      const start = (e) => {
        e.preventDefault();
        longPressTargetId = caseId;
        const cdata = allCases.find(x => x.id === caseId);
        longPressData = cdata || null;
        longPressTimer = setTimeout(() => {
          if (longPressTargetId && longPressData) {
            openAcceptModal(longPressData);
          }
        }, 800); // 0.8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      };

      const cancel = () => {
        clearTimeout(longPressTimer);
        longPressTargetId = null;
        longPressData = null;
      };

      row.addEventListener("mousedown", start);
      row.addEventListener("touchstart", start, {passive: false});
      row.addEventListener("mouseup", cancel);
      row.addEventListener("mouseleave", cancel);
      row.addEventListener("touchend", cancel);
      row.addEventListener("touchcancel", cancel);
    });
  }

  // =========================
  // 12) Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™
  // =========================
  const detailModal = $("detailModal");
  const detailContent = $("detailContent");

  function openDetailModal(c) {
    const victimImagesHtml = (c.victimImageUrls || []).map(url => {
      return `<div class="gallery-thumb"><img src="${url}" alt="victim image"></div>`;
    }).join("");

    const helperInfoHtml = c.helperName ? `
      <div class="modal-section">
        <div class="modal-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
        <div><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${c.helperName}</div>
        <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${c.helperPhone || "-"}</div>
        <div><strong>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô:</strong> ${c.helperContactAlt || "-"}</div>
        <div><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™:</strong> ${formatDateTime(c.helperAcceptedAt)}</div>
        ${c.helperImageUrl ? `
          <div class="gallery-row" style="margin-top:4px;">
            <div class="gallery-thumb"><img src="${c.helperImageUrl}" alt="helper image"></div>
          </div>` : ""}
      </div>
    ` : `
      <div class="modal-section">
        <div class="modal-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
        <div class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ</div>
      </div>
    `;

    const areaText =
      (c.subdistrictName ? `‡∏ï.${c.subdistrictName} ` : "") +
      (c.districtName ? `‡∏≠.${c.districtName} ` : "") +
      (c.provinceName ? `‡∏à.${c.provinceName}` : "");

    detailContent.innerHTML = `
      <div class="modal-section">
        <div class="modal-section-title">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:4px;">
          ${statusBadge(c.status)}
          <span class="badge-small">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDateTime(c.createdAt)}</span>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</div>
        <div class="modal-grid-two">
          <div><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${c.requesterName || "-"}</div>
          <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${c.requesterPhone || "-"}</div>
        </div>
        <div><strong>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô:</strong> ${c.requesterContactAlt || "-"}</div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
        <div><strong>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</strong> ${c.needs || "-"}</div>
        <div style="margin-top:4px;"><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå:</strong><br>${c.situation || "-"}</div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
        <div><strong>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong> ${areaText || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"}</div>
        <div><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> ${c.locationLat?.toFixed(5) || "-"}, ${c.locationLng?.toFixed(5) || "-"}</div>
        <div class="field-hint">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps ‡πÑ‡∏î‡πâ</div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</div>
        ${victimImagesHtml ? `<div class="gallery-row" style="margin-top:4px;">${victimImagesHtml}</div>` : '<div class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö</div>'}
      </div>

      ${helperInfoHtml}
    `;

    detailModal.classList.add("show");
  }

  // =========================
  // 13) Modal ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™
  // =========================
  const acceptModal = $("acceptModal");
  const acceptCaseSummary = $("acceptCaseSummary");
  const acceptForm = $("acceptForm");
  const helperImageInput = $("helperImageInput");
  const helperImagePreview = $("helperImagePreview");
  const acceptSubmitBtn = $("acceptSubmitBtn");

  function openAcceptModal(c) {
    selectedCaseForAccept = c;
    selectedCaseIdForAccept = c.id;
    helperImageFile = null;
    helperImagePreview.innerHTML = "";
    $("helperName").value = "";
    $("helperPhone").value = "";
    $("helperContactAlt").value = "";

    const areaText =
      (c.subdistrictName ? `‡∏ï.${c.subdistrictName} ` : "") +
      (c.districtName ? `‡∏≠.${c.districtName} ` : "") +
      (c.provinceName ? `‡∏à.${c.provinceName}` : "");

    acceptCaseSummary.innerHTML = `
      <div><strong>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> ${c.requesterName || "-"}</div>
      <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${c.requesterPhone || "-"}</div>
      <div><strong>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</strong> ${c.needs || "-"}</div>
      <div><strong>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong> ${areaText || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"}</div>
      <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> ${c.status || "-"}</div>
      <div class="text-muted small" style="margin-top:4px;">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ</div>
    `;

    acceptModal.classList.add("show");
  }

  helperImageInput.addEventListener("change", () => {
    const file = helperImageInput.files[0];
    helperImageFile = null;
    helperImagePreview.innerHTML = "";
    if (!file) return;
    helperImageFile = file;
    const url = URL.createObjectURL(file);
    const div = document.createElement("div");
    div.className = "image-chip";
    div.innerHTML = `<img src="${url}"><span>‚úî</span>`;
    helperImagePreview.appendChild(div);
  });

  acceptForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!selectedCaseIdForAccept || !selectedCaseForAccept) {
      showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", "error");
      return;
    }

    const helperName = $("helperName").value.trim();
    const helperPhone = $("helperPhone").value.trim();
    const helperContactAlt = $("helperContactAlt").value.trim();

    if (!helperName || !helperPhone) {
      showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "error");
      return;
    }

    if (!helperImageFile) {
      showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢", "error");
      return;
    }

    acceptSubmitBtn.disabled = true;
    acceptSubmitBtn.innerHTML = '<span class="loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‚Ä¶';

    try {
      const docId = selectedCaseIdForAccept;
      const ext = helperImageFile.name.split(".").pop();
      const fileName = `helper_${Date.now()}.${ext}`;
      const storageRef = storage.ref().child(`helper_images/${docId}/${fileName}`);
      await storageRef.put(helperImageFile);
      const url = await storageRef.getDownloadURL();

      await db.collection(HELP_COLLECTION).doc(docId).update({
        helperName: helperName,
        helperPhone: helperPhone,
        helperContactAlt: helperContactAlt || null,
        helperImageUrl: url,
        status: "accepted",
        helperAcceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      showToast("‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠", "success");
      acceptModal.classList.remove("show");

    } catch (err) {
      console.error(err);
      showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™", "error");
    } finally {
      acceptSubmitBtn.disabled = false;
      acceptSubmitBtn.innerHTML = '<span class="btn-icon">‚úÖ</span> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ';
    }
  });

  // =========================
  // 14) ‡∏õ‡∏¥‡∏î Modal
  // =========================
  document.querySelectorAll(".modal-close").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-close-modal");
      if (id) {
        $(id).classList.remove("show");
      }
    });
  });

  [acceptModal, detailModal].forEach(modal => {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.remove("show");
      }
    });
  });

</script>
</body>
</html>
